# rkbdb2xml GUI - UI設計と開発計画

## 1. はじめに

本文書は、PySide (Qt for Python) を用いて構築される `rkbdb2xml` ツールのグラフィカルユーザーインターフェース (GUI) の UI 設計と開発計画の概要を記述します。この GUI は、Rekordbox プレイリストの選択、プレイリストごとのエクスポートオプションの設定、および生成される XML ファイルの出力先の指定をユーザーフレンドリーに行うことを目的としています。

## 2. UI設計

メインアプリケーションウィンドウは、明瞭さと使いやすさを重視して設計します。

### 2.1. メインウィンドウレイアウト

メインウィンドウは以下のセクションに分割されます:

*   **メニューバー**:
    *   `ファイル`:
        *   `Rekordboxデータベースを読み込む...` (自動検出失敗時やユーザー指定時)
        *   `設定/環境設定...` (グローバル設定用、例: デフォルトのローマ字/BPM付与)
        *   `終了`
    *   `ヘルプ`:
        *   `バージョン情報`
*   **メインペイン: プレイリストとオプションテーブル**
    *   Rekordbox のプレイリストとフォルダを表示するテーブルビュー (`QTableView`)。
    *   プレイリストとフォルダはフラットなリストで表示され、階層は「名前」列のインデントによって示されます。
    *   初期状態では、すべてのフォルダが展開された状態で表示されます。
    *   各行はプレイリストまたはフォルダを表します。
    *   列には、エクスポート選択チェックボックス、アイテム名、および様々なエクスポートオプション（例: ソート順、BPM追加、ローマ字化オプション）が含まれます。エクスポートオプション列はプレイリスト行に対してのみ編集可能です。
    *   テーブルの上部に「プレイリスト再読み込み」ボタン。
*   **下ペイン: グローバル設定とエクスポート**
    *   出力ディレクトリ: パス入力用の `QLineEdit` と選択用の `QPushButton` (「参照...」)。
    *   グローバルエクスポートオプション（上書き）: 「選択項目すべてにローマ字変換を強制」、「選択項目すべてにBPM付与を強制」のチェックボックス。
    *   「エクスポート開始」 `QPushButton`。
*   **ステータスバー**:
    *   進行中の処理に関する情報を表示 (例: 「プレイリスト読み込み中...」、「プレイリストXをエクスポート中...」、「エクスポート完了」)。
    *   エクスポート中の視覚的フィードバックのための `QProgressBar`。

### 2.2. ビジュアルモックアップ（概念図 - テーブルビュー）

```
+----------------------------------------------------------------------------------------------------------------------------------------------------+
| ファイル  ヘルプ                                                                                                                                   |
+----------------------------------------------------------------------------------------------------------------------------------------------------+
| [プレイリスト再読み込み]                                                                                                                             |
|----------------------------------------------------------------------------------------------------------------------------------------------------|
| [X] | 名前                 | ソート順        | BPM追加 | タイトルローマ字化 | アーティストローマ字化 | アルバムローマ字化 |  <- 列ヘッダー                      |
|-----|----------------------|-----------------|---------|--------------------|--------------------|--------------------|------------------------------------|
| [X] | フォルダ 1           | (無効)          | (無効)  | (無効)             | (無効)             | (無効)             |  <- フォルダ行 (オプション無効)   |
| [ ] |   プレイリスト A     | [デフォルト v]  | [ ]     | [ ]                | [ ]                | [ ]                |  <- プレイリスト行 (オプション編集可) |
| [X] |   プレイリスト B     | [BPM昇順  v]    | [X]     | [X]                | [ ]                | [ ]                |                                    |
| [ ] | フォルダ 2           | (無効)          | (無効)  | (無効)             | (無効)             | (無効)             |                                    |
| [X] |   My Mix 1         | [デフォルト v]  | [X]     | [ ]                | [X]                | [X]                |                                    |
| [ ] |   サブフォルダ 2.1   | (無効)          | (無効)  | (無効)             | (無効)             | (無効)             |                                    |
| [ ] |     Deep Playlist C| [タイトル   v]  | [ ]     | [ ]                | [ ]                | [ ]                |                                    |
| [ ] | 未分類プレイリスト   | [デフォルト v]  | [ ]     | [ ]                | [ ]                | [ ]                |                                    |
| ... | ...                  | ...             | ...     | ...                | ...                | ...                |                                    |
+----------------------------------------------------------------------------------------------------------------------------------------------------+
| 出力ディレクトリ: [ C:\Exports           ] [参照...]                                                                                                |
| グローバル: [ ] ローマ字強制  [ ] BPM強制                                                                      [ エクスポート開始 ]                 |
+----------------------------------------------------------------------------------------------------------------------------------------------------+
| ステータス: 準備完了                                                                                               [|||||-----] 50%                |
+----------------------------------------------------------------------------------------------------------------------------------------------------+
(X) = チェックあり, [ ] = チェックなしボックス, [オプション v] = ドロップダウン
```

### 2.3. プレイリスト/フォルダ テーブルビュー (`QTableView`)

*   `pyrekordbox` から読み込まれたプレイリストとフォルダをテーブル形式で表示。
*   初期状態では、すべてのフォルダが展開され、すべてのプレイリストとサブフォルダが表示されます。階層は「名前」フィールドのインデントによって示されます。
*   このビューの背後にあるモデルは、プレイリスト/フォルダID、それらのエクスポート状態、およびそれらの特定のエクスポートオプションを格納します。
*   **列構成**:
    *   **エクスポート**: 各行に `QCheckBox` を配置し、アイテムをエクスポート対象として選択。フォルダをチェックすると、オプションですべての子アイテムをチェックすることも可能。
    *   **名前**: プレイリストまたはフォルダ名を表示するテキストフィールド。インデントを使用してフォルダ/プレイリスト階層を表現。
    *   **ソート順**: `QComboBox` (プレイリスト行のみ編集可能)。オプション: 「デフォルト」、「BPM (昇順)」、「BPM (降順)」、「タイトル」、「アーティスト」。フォルダ行では無効。
    *   **タイトルにBPMを追加**: `QCheckBox` (プレイリスト行のみ編集可能)。フォルダ行では無効。
    *   **タイトルをローマ字化**: `QCheckBox` (プレイリスト行のみ編集可能)。フォルダ行では無効。
    *   **アーティストをローマ字化**: `QCheckBox` (プレイリスト行のみ編集可能)。フォルダ行では無効。
    *   **アルバムをローマ字化**: `QCheckBox` (プレイリスト行のみ編集可能)。フォルダ行では無効。

### 2.4. オプションペイン (プレイリストごと)

*このセクションは削除されました。オプションは各プレイリスト行のテーブル内で直接編集されるためです。*

## 3. コア機能詳細

### 3.1. プレイリスト読み込み

*   起動時または「プレイリスト再読み込み」クリック時に、アプリケーションは `pyrekordbox` を使用してすべてのプレイリストとフォルダを取得。
*   GUIの応答性を保つため、この処理はバックグラウンドスレッド (`QThread`) で実行。
*   テーブルビューが生成される。展開されたツリーを表すフラットなリストが作成される。各アイテムは `DjmdPlaylist` オブジェクトまたは関連属性 (ID, Name, ParentID, is_folder, インデント用のレベル) を格納。

### 3.2. オプション設定

*   データ構造 (例: 辞書) が、選択または設定された各プレイリストIDのエクスポートオプションを保持。
    *   `{ playlist_id: {"sort_order": "bpm", "add_bpm": True, "romanize_title": False, ...}, ... }`
*   オプションはプレイリスト行のテーブルセルで直接編集される。テーブルでの変更（例: チェックボックスのチェック、コンボボックスからの選択）は、対応するプレイリストIDのこの一時ストレージを更新する。
*   フォルダ行ではオプションセルの編集は不可。

### 3.3. エクスポート処理

1.  ユーザーが「エクスポート開始」をクリック。
2.  出力ディレクトリを検証。
3.  「エクスポート」チェックボックスがチェックされている行からすべてのプレイリストIDを収集。
4.  チェックされた各プレイリストについて:
    *   保存された設定から特定のオプションを取得。
    *   未設定の場合、グローバルデフォルトまたはアプリケーションデフォルトを使用。
    *   `RekordboxXMLExporter` クラスまたは `export_rekordbox_db_to_xml` 関数は、これらの詳細なプレイリストごとのオプションを受け入れるように適合させる必要がある。これは、オプションがグローバルである現在のCLIからの大幅な変更点。
    *   あるいは、GUIが反復処理を行い、異なるプレイリストフィルタとオプションで `export_rekordbox_db_to_xml` を複数回呼び出し、個別の（またはマージされた）XMLを生成することも可能。現在のツールのような単一でまとまりのあるXMLが望ましいため、`RekordboxXMLExporter` 自体がより柔軟になる必要がある。
5.  エクスポート処理は `QThread` で実行。
6.  ステータスバーとプログレスバーが更新される。

## 4. 開発計画

### 4.1. 前提条件

*   Python 3.8+
*   PySide6: `pip install pyside6`
*   既存の `rkbdb2xml` コードベース。

### 4.2. マイルストーン

**M0: プロジェクト設定と基本構造**

- [x] GUI関連ファイル用の新しいディレクトリを作成 (例: `rkbdb2xml_gui/`)。
- [x] 基本的なPySideアプリケーションを設定: `QApplication`, `QMainWindow`。
- [x] Qt Designer (`.ui`ファイル) を使用するかプログラムで、テーブル、オプションなどのプレースホルダーを含むメインウィンドウレイアウトを実装。

**M1: プレイリストの読み込みと表示**

- [x] **タスク 1.1**: `RekordboxDatabase` からプレイリストとフォルダを読み込むロジックを実装 (理想的には `QThread` 内で)。
  - [x] テーブル表示用に階層をフラット化し、必要なインデントレベルを計算。
  - [x] すべてのフォルダがデフォルトで展開されているものとして扱われるようにする。
  - [x] DBが見つからない場合のエラー処理。
  - [x] 「読み込み中...」ステータスを表示。
- [x] **タスク 1.2**: `QTableView` にプレイリスト/フォルダデータを生成。
  - [x] オプション用のテーブルセル内にチェックボックスやコンボボックスを表示するために、カスタムデリゲートを実装するか標準アイテムモデルを使用。
  - [x] 「名前」列にインデントを実装して階層を表示。
  - [x] 各行/アイテムにプレイリスト/フォルダメタデータ (ID, name, type, 元の階層データ) を保存。
- [x] **タスク 1.3**: 「プレイリスト再読み込み」ボタンを実装。

**M2: 出力パスと基本エクスポートトリガー**

- [x] **タスク 2.1**: 出力ディレクトリ `QLineEdit` と 「参照...」 `QPushButton` (`QFileDialog.getExistingDirectory()` を使用) を実装。
- [x] **タスク 2.2**: 基本的な「エクスポート開始」ボタンを実装。
  - [x] 初期段階では、実際のエクスポートなしに、選択されたプレイリストIDと出力パスを単に出力する。

**M3: プレイリストごとのオプションUIとデータモデル（テーブルに統合）**

- [x] **タスク 3.1**: `QTableView` 内で `QCheckBox` および `QComboBox` デリゲートを使用して、プレイリストオプションのインテーブル編集を実装。
  - [x] フォルダ行のオプションセルが無効/編集不可であることを確認。
- [x] **タスク 3.2**: プレイリストのテーブルセルオプションが変更された場合、プレイリストIDに関連付けられたPython辞書にそれらを保存。
- [x] **タスク 3.3**: (削除 - 以前の別個のオプションペイン用だったため)
- [x] **タスク 3.4**: (旧計画の3.2から再番号付け、現行計画の3.1および3.2の一部)

**M4: コアエクスポートロジックの適合**
- [x] **重要ステップ**: `RekordboxXMLExporter` または `export_rekordbox_db_to_xml` を変更。
  - [x] エクスポーターは、(playlist\_id, options\_dict) タプルのリストを受け取るか、プレイリストIDでクエリできるグローバルな options\_map を認識できる必要がある。
  - [x] 選択されたプレイリストに基づいてトラックをフィルタリングし、トラック/プレイリスト処理中に*条件付きで*オプションを適用する必要がある。
  - [x] これには、オプション辞書をXML生成メソッドの深部に渡すことが含まれる場合がある。
- [x] **タスク 4.2**: 「エクスポート開始」ボタンをこの変更されたエクスポートロジックに接続。
  - [x] エクスポートは `QThread` で実行する必要がある。
  - [x] 収集されたプレイリスト選択とそれに関連するオプションを渡す。

**M5: 進捗報告とフィードバック**

- [x] **タスク 5.1**: エクスポート中の `QProgressBar` 更新を実装。
  - [ ] `RekordboxXMLExporter` は進捗を示すシグナル (例: `processed_playlist(name)`, `processed_track_count(count)`) を発行する必要がある。
- [x] **タスク 5.2**: ステータスバーメッセージを更新。
- [x] **タスク 5.3**: 完了時に成功/エラーダイアログ (`QMessageBox`) を表示。

**M6: 設定、改良、エラー処理**

- [ ] **タスク 6.1**: グローバル設定/環境設定を実装 (例: 最後の出力パスの永続化、`QSettings` を使用したデフォルトオプション)。
- [ ] **タスク 6.2**: 「バージョン情報」ダイアログを追加。
- [x] **タスク 6.3**: アプリケーション全体のエラー処理を改善 (例: 無効なDBパス、書き込み権限エラー)。
- [ ] **タスク 6.4**: UIの洗練: アイコン、ツールチップ、レイアウト調整。

**M7: テストとパッケージング**

- [ ] **タスク 7.1**: ターゲットプラットフォーム (Windows, macOS) でGUI機能を徹底的にテスト。
- [ ] **タスク 7.2**: PyInstallerを使用して実行可能バージョンを作成。
  - [ ] PySide6とすべての依存関係が正しくバンドルされていることを確認。
  - [ ] パッケージ化されたアプリケーションをテスト。

## 5. 主要な課題と考慮事項

*   **`RekordboxXMLExporter` の変更**: 最も重要な課題は、既存のエクスポートロジックを、コアコードを過度に複雑にすることなく、プレイリストごとのオプションを適切に処理するように適合させること。現在のCLIオプションはグローバル。
*   **スレッド管理**: DB読み込みとエクスポートに `QThread` を正しく使用することが、応答性の高いGUIには不可欠。スレッド間の通信にはシグナルとスロットを使用。
*   **状態管理**: 選択されたプレイリスト/フォルダ（テーブル内のチェックボックス経由）とそれらの個別のオプション（テーブル内で編集）を追跡。
*   **依存関係のバンドル**: `lxml`, `mutagen`, `psutil`, `romann` (Python以外の部分がある場合) は、PyInstallerで特別な処理が必要になる場合がある。

## 6. 将来の拡張機能（オプション）

*   エクスポート用プレイリストのドラッグアンドドロップによる並べ替え (XML構造が許容/重要である場合)。
*   エクスポート「プロファイル」(選択されたプレイリストとそのオプションのセット) の保存/読み込み。
*   エクスポート前の一部のトラックメタデータの直接編集 (複雑)。
*   より多くのエクスポートオプションのためのプラグインシステム。
